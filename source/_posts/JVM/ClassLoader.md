---
title: 类加载机制
date: 2021-03-11 21:11:00
author: yancyan
categories: 虚拟机
tags:
- JVM
---

## 介绍
Java虚拟机把描述类的Class文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可被虚拟机使用的Java类型，这个过程被称作虚拟机的类加载机制。


## 加载时机
一个类型从被加载到虚拟机内存开始到卸载出内存为止，这个生命周期要经历加载、验证、准备、解析、初始化、使用和卸载七个阶段，如下图
![类的生命周期](/images/java_class_loader.png)
其中加载、验证、准备、初始化和卸载这五个阶段是顺序（开始的顺序，执行阶段可能会交叉）确定的。解析阶段则不一定，某些情况下可以在初始化阶段之后开始，这是为了支持Java语言的运行时绑定特性。

对于初始化阶段，《Java虚拟机规范》严格规定了**有且仅有**7六种情况下必须对类进行”初始化“
1. 遇到new、getstatic、putstatic、和invokestatic这四条字节码指令时
    - new关键字实例化对象
    - 读取和设置一个类型的静态字段（final修饰，已在编译器放入常量池的静态字段除外）
    - 调用一个类型的静态方法
    
2. 使用反射对类型进行反射调用
3. 初始化类时，如果父类还未初始化要先对父类进行初始化
4. 虚拟机启动，用户需要指定要执行的主类
5. 当使用JDK7新加入的动态语言支持时，如果`java.lang.invoke.MethHandle`实例最后的解析结果为REF_getStatic\REF_putStatic\REF_invokeStatic\REF_newInvokeSpecial四种类型的方法句柄
6. 当一个接口中定义了JDK8新加入的默认方法，如果这个接口的实现类进行了初始化，那这个接口也要在之前进行初始化


## 加载过程
### 加载
加载阶段虚拟机需要完成三件事
1. 通过一个类的全限定名获取二进制字节流
2. 将这个字节流代表的静态存储结构转化为方法区的运行时数据结构
3. 在内存中生成一个代表这个类的Class对象，最为方法区这个类的各种数据访问入口

虚拟机规范对这三点要求并不特别具体，所以虚拟机实现的灵活度很大，”通过一个类的全限定名获取二进制字节流“衍生了很多技术
- 从ZIP压缩包中读取，最终形成了JAR.EAR,WAR格式的基础
- 从网络中获取，典型的WebApplet
- 运行时计算生成，如动态代理技术
- 由其他文件生成， 典型场景JSP应用
- 从数据库读取
- 从加密文件中获取
- ...

数组比较特殊，数组类本身不通过类加载器创建，是由Java虚拟机直接在内存中动态构造出阿里，但是数组类的元素类型最终还是要靠类加载器完成加载，一个数组类创建过程遵循一下规则：
- 数组的元素类型是引用类型，递归加载这些引用类型，数组类被标识在加载数组元素类型的类加载器的类名空间上
- 如果数组元素不是引用类型，虚拟机将会把数组类标记为与引导类加载器关联
- 数组类的可访问性和它的元素类型的可访问性一致，如果元素类型不是引用类，那数组类的可访问性默认public，

加载结束后，外部的二进制字节流就按照虚拟机设定的格式存储在方法区。类型数据放到方法区以后，会在Java堆内存中实例化一个Class类对象，这个类对象作为程序访问方法区的类型数据的外部入口。


### 验证
验证是连接的第一步，确保Class文件的字节流中包含的信息符合《Java虚拟机规范》的全部约束。
大致分为四个阶段的检验动作：文件格式验证、元数据验证、字节码验证和符号引用验证
#### 1. 文件格式验证

#### 2. 元数据验证

#### 3. 字节码验证

#### 4. 符号引用验证


### 准备

### 解析

### 初始化

## 类加载器

## Java模块化系统

















